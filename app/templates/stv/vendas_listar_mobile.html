{% extends "base_mobile.html" %}
{% block title %}Vendas{% endblock %}

{% block content %}

<h5 class="mb-3 fw-bold text-center">
  Vendas de Streaming
</h5>

<!-- Busca -->
<form method="get" class="mb-3">

  <input type="hidden" name="data_ini" value="{{ data_ini or '' }}">
  <input type="hidden" name="data_fim" value="{{ data_fim or '' }}">
  <input type="hidden" name="status" value="{{ status or '' }}">
  <input type="hidden" name="vendedor_id" value="{{ vendedor_id or '' }}">

  <div class="input-group input-group-sm">
    <span class="input-group-text">
      <i class="fas fa-search"></i>
    </span>

    <input type="text"
           name="busca"
           value="{{ busca }}"
           class="form-control"
           placeholder="Buscar cliente, conta ou serviÃ§o">

    {% if busca %}
    <a href="{{ url_for('routes.stv_listar_vendas_mobile') }}"
       class="btn btn-outline-secondary"
       title="Limpar busca">
      <i class="fas fa-arrows-rotate"></i>
    </a>
    {% endif %}
  </div>
</form>

<!-- Lista -->
<div class="d-grid gap-2">

  {% for v in vendas.items %}
  <div class="card shadow-sm border-0">

    <div class="card-body p-2">

      <!-- Cliente + Data -->
      <div class="d-flex justify-content-between align-items-start">
        <strong class="fs-6">
          {{ v.cliente.nome }}
        </strong>

        <span class="badge bg-secondary">
          {{ v.data_venda|br_data_hora }}
        </span>
      </div>

      <!-- Vendedor -->
      <div class="d-flex align-items-center mt-1 text-muted small">
        <i class="fas fa-user-tie me-1"></i>
        <span>{{ v.vendedor.nome }}</span>
      </div>

      <!-- ServiÃ§o / Tela -->
      <div class="text-muted small mt-1">
        {{ v.servico.nome }} Â· Tela {{ v.tela.numero if v.tela else '-' }}
      </div>

      <!-- Conta -->
      <div class="mt-1 small">
        <strong>Conta:</strong>
        {{ v.tela.conta.email if v.tela and v.tela.conta else '-' }}
      </div>

      <!-- Valores + Status -->
      <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
          <strong>R$ {{ v.valor_venda|br_moeda  }}</strong>
          <div class="small text-muted">
            ComissÃ£o: R$ {{ v.valor_comissao|br_moeda  }}
          </div>
        </div>

        <div>
          {% if v.status == 'ATIVA' %}
            <span class="badge bg-success">Ativa</span>
          {% elif v.status == 'PENDENTE' %}
            <span class="badge bg-warning text-dark">Pendente</span>
          {% else %}
            <span class="badge bg-secondary">Cancelada</span>
          {% endif %}
        </div>
      </div>

      <!-- AÃ§Ãµes -->
      <div class="d-flex flex-column gap-1 mt-2">

        {% if v.status == 'PENDENTE' %}
        <a href="{{ url_for('routes.stv_finalizar_venda', venda_id=v.id) }}"
           class="btn btn-sm btn-success w-100">
          Finalizar
        </a>
        {% endif %}

        {% if v.status == 'ATIVA' %}
        <button class="btn btn-sm btn-outline-success w-100"
                data-bs-toggle="modal"
                data-bs-target="#modalWhatsapp"
                data-telefone="{{ v.cliente.telefone }}"
                data-servico="{{ v.servico.nome }}"
                data-email="{{ v.tela.conta.email }}"
                data-senha="{{ v.tela.conta.senha }}">
          <i class="fab fa-whatsapp"></i> Reenviar WhatsApp
        </button>
        {% endif %}

        {% if v.status != 'CANCELADA' %}
        <form method="POST"
              action="{{ url_for('routes.stv_cancelar_venda', venda_id=v.id) }}"
              onsubmit="return confirm('Cancelar venda?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-sm btn-warning w-100">
            Cancelar
          </button>
        </form>
        {% endif %}

      </div>

    </div>
  </div>
  {% else %}
    <div class="text-center text-muted">
      Nenhuma venda encontrada
    </div>
  {% endfor %}

</div>

<!-- PaginaÃ§Ã£o -->
{% if vendas.pages > 1 %}
<nav class="mt-3">
  <ul class="pagination pagination-sm justify-content-center">

    <li class="page-item {% if not vendas.has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('routes.stv_listar_vendas_mobile',
                          page=vendas.prev_num,
                          busca=busca) }}">
        Â«
      </a>
    </li>

    <li class="page-item disabled">
      <span class="page-link">
        {{ vendas.page }} / {{ vendas.pages }}
      </span>
    </li>

    <li class="page-item {% if not vendas.has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('routes.stv_listar_vendas_mobile',
                          page=vendas.next_num,
                          busca=busca) }}">
        Â»
      </a>
    </li>

  </ul>
</nav>
{% endif %}

<!-- Voltar -->
<a href="{{ url_for('routes.home') }}"
   class="btn btn-outline-info w-100 mt-3">
  â† Voltar
</a>

<!-- MODAL WHATSAPP -->
<div class="modal fade" id="modalWhatsapp" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-0">

      <div class="modal-header border-secondary">
        <h5 class="modal-title">Mensagem para o Cliente</h5>
        <button class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <textarea id="msgWhatsapp"
                  class="form-control bg-dark text-white border-secondary mb-3"
                  rows="6"
                  readonly></textarea>

        <button class="btn btn-success w-100 mb-2"
                onclick="copiarMensagem()">
          ğŸ“‹ Copiar mensagem
        </button>

        <a id="btnWhatsapp"
           href="#"
           target="_blank"
           class="btn btn-primary w-100">
          ğŸ’¬ Abrir WhatsApp
        </a>
      </div>

    </div>
  </div>
</div>

<script>
function copiarMensagem() {
  const t = document.getElementById("msgWhatsapp");
  t.select();
  document.execCommand("copy");
}

document.getElementById("modalWhatsapp")
  .addEventListener("show.bs.modal", function (event) {

    const btn = event.relatedTarget;

    const telefone = (btn.dataset.telefone || "").replace(/\D/g, "");
    const servico  = btn.dataset.servico;
    const email    = btn.dataset.email;
    const senha    = btn.dataset.senha;

    const msg = `*${servico.toUpperCase()}*

ğŸ‘¤ email: ${email}
ğŸ”‘ senha: ${senha}

Agradecemos a preferÃªncia! âœ…ğŸ¿`;

    document.getElementById("msgWhatsapp").value = msg;

    if (telefone) {
      document.getElementById("btnWhatsapp").href =
        `https://wa.me/55${telefone}?text=${encodeURIComponent(msg)}`;
    }
});
</script>

{% endblock %}
