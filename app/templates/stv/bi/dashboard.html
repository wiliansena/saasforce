<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>BI ‚Ä¢ Streaming</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    background: radial-gradient(circle at top, #0d1b2a, #000814);
    color: #fff;
    font-family: Inter, system-ui, Arial, sans-serif;
}

.card-dark {
    background: linear-gradient(145deg, #0b132b, #020617);
    border-radius: 16px;
    padding: 18px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    height: 100%;
}

.kpi-title {
    font-size: 13px;
    opacity: .9;
}

.kpi-value {
    font-size: 26px;
    font-weight: 700;
    color: #fff;
}

canvas {
    max-height: 280px;
}
        .btn-back {
            display: inline-block;
            margin: 18px 0 0 20px;
            padding: 10px 14px;
            background: #111827;
            color: #22d3ee;
            border: 1px solid #22d3ee;
            border-radius: 10px;
            transition: .2s;
            font-weight: 700;
            text-decoration: none;
            /* REMOVE o sublinhado */
        }

        .btn-back:hover {
            background: #22d3ee;
            color: #0b0f14;
        }
</style>
</head>

<body>

<div class="container-fluid p-4">

    <h3 class="mb-4 fw-bold">BI ‚Ä¢ Streaming</h3>
    <!-- üîπ Filtros -->
    <form class="row g-3 mb-4" method="GET">
        <div class="col-md-3">
            <label class="form-label">De</label>
            <input type="date" name="data_ini" value="{{ data_ini or '' }}" class="form-control">
        </div>

        <div class="col-md-3">
            <label class="form-label">At√©</label>
            <input type="date" name="data_fim" value="{{ data_fim or '' }}" class="form-control">
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-info w-100 fw-bold">Aplicar</button>
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <a href="{{ url_for('routes.home') }}"
               class="btn btn-outline-light w-100">
                ‚Üê Voltar
            </a>
        </div>
    </form>

    <!-- üîπ KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card-dark">
                <div class="kpi-title">Total Vendido</div>
                <div id="kpi-vendido" class="kpi-value">‚Äî</div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card-dark">
                <div class="kpi-title">Total Investido</div>
                <div id="kpi-investido" class="kpi-value">‚Äî</div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card-dark">
                <div class="kpi-title">Total Comiss√£o</div>
                <div id="kpi-comissao" class="kpi-value">‚Äî</div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card-dark">
                <div class="kpi-title">Lucro</div>
                <div id="kpi-lucro" class="kpi-value">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- üîπ Gr√°ficos -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card-dark">
                <h6 class="mb-3">Vendido por Dia</h6>
                <canvas id="chartDia"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card-dark">
                <h6 class="mb-3">Comiss√£o por Vendedor</h6>
                <canvas id="chartVendedor"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
const params = new URLSearchParams(window.location.search).toString();

// üîπ KPIs
fetch(`/stv/bi/kpis?${params}`)
.then(r => r.json())
.then(d => {
    document.getElementById("kpi-vendido").innerText   = d.total_vendido;
    document.getElementById("kpi-investido").innerText = d.total_investido;
    document.getElementById("kpi-comissao").innerText  = d.total_comissao;
    document.getElementById("kpi-lucro").innerText     = d.lucro;
});

// üîπ Vendido por dia
fetch(`/stv/bi/vendido_por_dia?${params}`)
.then(r => r.json())
.then(rows => {
    new Chart(document.getElementById("chartDia"), {
        type: "line",
        data: {
            labels: rows.map(r => r.dia),
            datasets: [{
                label: "R$ Vendido",
                data: rows.map(r => r.total),
                borderColor: "#22d3ee",
                backgroundColor: "rgba(34,211,238,.15)",
                tension: .3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
});

// üîπ Comiss√£o por vendedor
fetch(`/stv/bi/comissao_por_vendedor?${params}`)
.then(r => r.json())
.then(rows => {
    new Chart(document.getElementById("chartVendedor"), {
        type: "bar",
        data: {
            labels: rows.map(r => r.vendedor),
            datasets: [{
                label: "Comiss√£o (R$)",
                data: rows.map(r => r.total),
                backgroundColor: "#22d3ee"
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
});
</script>

</body>
</html>
