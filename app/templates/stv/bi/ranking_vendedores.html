{% extends "base_mobile.html" %}
{% block content %}

<style>
  /* üîπ DARK STYLE (baseado no BI Streaming) */
  .card-dark {
    background: linear-gradient(145deg, #0b132b, #020617);
    border-radius: 16px;
    padding: 14px;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .05);
  }

  .form-control {
    background: #020617;
    border: 1px solid rgba(255, 255, 255, .1);
    color: #fff;
  }

  .form-control:focus {
    background: #020617;
    color: #fff;
    border-color: #22d3ee;
    box-shadow: none;
  }

  .chart-container {
    position: relative;
    width: 100%;
    height: 260px;
    /* mobile first */
  }

  @media (min-width: 768px) {
    .chart-container {
      height: 340px;
    }
  }
</style>

<div class="container-fluid mt-3">

  <h4 class="mb-3 fw-bold text-white">
    Ranking de Vendedores
  </h4>
  <a href="{{ url_for('routes.home') }}" class="btn btn-outline-info w-100 mt-3">
    ‚Üê Voltar
  </a>
  <hr>
  <!-- üîπ FILTRO -->
  <form id="filtroForm" class="row g-2 mb-3">

    <div class="col-6">
      <input type="date" name="data_ini" id="data_ini" class="form-control" value="{{ data_ini }}">
    </div>

    <div class="col-6">
      <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
    </div>

    <div class="col-12">
      <button class="btn btn-info w-100 fw-bold mt-2">
        Filtrar
      </button>
    </div>

  </form>

  <!-- üîπ GR√ÅFICO -->
  <div class="card-dark">
    <div class="chart-container">
      <canvas id="graficoComissao"></canvas>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let chart;

  async function carregarGrafico() {

    const dataIni = document.getElementById("data_ini").value;
    const dataFim = document.getElementById("data_fim").value;

    const url = `/stv/bi/comissao_por_vendedor?data_ini=${dataIni}&data_fim=${dataFim}`;

    const resp = await fetch(url);
    const dados = await resp.json();

    const labels = dados.map(d => d.vendedor);
    const valores = dados.map(d => d.total);

    const ctx = document.getElementById("graficoComissao");

    if (chart) {
      chart.destroy();
    }

    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          data: valores,
          backgroundColor: "#22d3ee",
          borderRadius: 8,
          barThickness: 16,
          maxBarThickness: 22
        }]
      },
      options: {
        indexAxis: 'y', // üëà horizontal (MELHOR no mobile)
        responsive: true,
        maintainAspectRatio: false,

        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "#020617",
            titleColor: "#fff",
            bodyColor: "#e5e7eb",
            padding: 10,
            cornerRadius: 8,
            callbacks: {
              label: function (ctx) {
                const v = dados[ctx.dataIndex].total_fmt;
                return `R$ ${v}`;
              }
            }
          }
        },

        scales: {
          x: {
            ticks: {
              color: "#cbd5f5"
            },
            grid: {
              color: "rgba(255,255,255,.06)"
            }
          },
          y: {
            ticks: {
              color: "#e5e7eb",
              font: { size: 12 }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", carregarGrafico);
</script>

{% endblock %}